<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Dropzone - Comprehensive Test Page</title>
    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #f8fafc;
      }
      .test-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .test-title {
        color: #1e40af;
        border-bottom: 2px solid #3b82f6;
        padding-bottom: 10px;
        margin-bottom: 20px;
      }
      .dropzone {
        border: 2px dashed #3b82f6;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        background: #f0f9ff;
        transition: all 0.2s ease;
        margin: 20px 0;
      }
      .dropzone.drag-active {
        border-color: #1e40af;
        background: #dbeafe;
        transform: scale(1.02);
      }
      .dropzone.drag-over {
        border-color: #059669;
        background: #d1fae5;
      }
      .file-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }
      .file-item {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 15px;
        position: relative;
        cursor: move;
        transition: all 0.2s ease;
      }
      .file-item:hover {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
      }
      .file-item.dragging {
        opacity: 0.5;
        transform: rotate(5deg) scale(1.05);
      }
      .file-item.drag-target {
        border-color: #3b82f6;
        background: rgba(59, 130, 246, 0.1);
      }
      .file-preview {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 4px;
        margin-bottom: 10px;
      }
      .file-info {
        font-size: 12px;
        color: #6b7280;
      }
      .progress-bar {
        width: 100%;
        height: 4px;
        background: #e5e7eb;
        border-radius: 2px;
        overflow: hidden;
        margin: 8px 0;
      }
      .progress-fill {
        height: 100%;
        background: #3b82f6;
        transition: width 0.3s ease;
      }
      .controls {
        display: flex;
        gap: 10px;
        margin: 20px 0;
        flex-wrap: wrap;
      }
      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s ease;
      }
      .btn-primary {
        background: #3b82f6;
        color: white;
      }
      .btn-primary:hover {
        background: #2563eb;
      }
      .btn-secondary {
        background: #6b7280;
        color: white;
      }
      .btn-secondary:hover {
        background: #4b5563;
      }
      .btn-danger {
        background: #ef4444;
        color: white;
      }
      .btn-danger:hover {
        background: #dc2626;
      }
      .status {
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
        font-weight: 500;
      }
      .status.success {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #10b981;
      }
      .status.error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #ef4444;
      }
      .status.info {
        background: #dbeafe;
        color: #1e40af;
        border: 1px solid #3b82f6;
      }
      .log {
        background: #1f2937;
        color: #f9fafb;
        padding: 15px;
        border-radius: 6px;
        font-family: "Monaco", "Menlo", monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
        margin: 20px 0;
      }
      .log-entry {
        margin: 5px 0;
        padding: 5px 0;
        border-bottom: 1px solid #374151;
      }
      .log-entry.error {
        color: #f87171;
      }
      .log-entry.warn {
        color: #fbbf24;
      }
      .log-entry.info {
        color: #60a5fa;
      }
      .log-entry.success {
        color: #34d399;
      }
    </style>
  </head>
  <body>
    <h1 class="test-title">üß™ Smart Dropzone - Comprehensive Test Suite</h1>

    <!-- Test Controls -->
    <div class="test-section">
      <h2>üéÆ Test Controls</h2>
      <div class="controls">
        <button class="btn btn-primary" onclick="testFileUpload()">
          Test File Upload
        </button>
        <button class="btn btn-secondary" onclick="testDragReorder()">
          Test Drag & Reorder
        </button>
        <button class="btn btn-secondary" onclick="testFilePreview()">
          Test File Preview
        </button>
        <button class="btn btn-secondary" onclick="testErrorHandling()">
          Test Error Handling
        </button>
        <button class="btn btn-secondary" onclick="testPerformance()">
          Test Performance
        </button>
        <button class="btn btn-danger" onclick="clearAll()">Clear All</button>
      </div>
      <div id="test-status"></div>
    </div>

    <!-- Main Dropzone -->
    <div class="test-section">
      <h2>üìÅ Main File Dropzone</h2>
      <div id="main-dropzone" class="dropzone">
        <div id="dropzone-content">
          <h3>Drop files here or click to select</h3>
          <p>Supports: Images, Videos, Documents, Archives</p>
          <p>Max files: 10 ‚Ä¢ Max size: 10MB</p>
          <input type="file" id="file-input" multiple style="display: none" />
          <button
            class="btn btn-primary"
            onclick="document.getElementById('file-input').click()"
          >
            Select Files
          </button>
        </div>
      </div>
    </div>

    <!-- File List -->
    <div class="test-section">
      <h2>üìã File List (Drag to Reorder)</h2>
      <div id="file-list" class="file-list"></div>
    </div>

    <!-- File Preview -->
    <div class="test-section">
      <h2>üñºÔ∏è File Preview System</h2>
      <div id="preview-container"></div>
    </div>

    <!-- Performance Monitor -->
    <div class="test-section">
      <h2>‚ö° Performance Monitor</h2>
      <div id="performance-stats"></div>
    </div>

    <!-- Error Log -->
    <div class="test-section">
      <h2>üìù Error & Event Log</h2>
      <div id="log-container" class="log"></div>
    </div>

    <!-- Test Results -->
    <div class="test-section">
      <h2>‚úÖ Test Results</h2>
      <div id="test-results"></div>
    </div>

    <script type="module">
      // Import our smart-dropzone package
      import {
        SmartDropzone,
        FileProcessor,
        FilePreviewManager,
        DragReorderManager,
        PerformanceMonitor,
        UploadError,
        ErrorBoundary,
        InputValidator,
        DEFAULT_CONFIG,
      } from "./dist/index.js";

      // Global state
      let currentFiles = [];
      let dragReorderManager;
      let performanceMonitor;
      let testResults = {};

      // Initialize components
      function initializeComponents() {
        try {
          // Initialize performance monitor
          performanceMonitor = PerformanceMonitor.getInstance();
          performanceMonitor.startRender();

          // Initialize drag reorder manager
          dragReorderManager = new DragReorderManager({
            enableReordering: true,
            animationDuration: DEFAULT_CONFIG.timing.animationDuration,
            dragThreshold: DEFAULT_CONFIG.layout.dragThreshold,
          });

          // Set up file input handling
          const fileInput = document.getElementById("file-input");
          fileInput.addEventListener("change", handleFileSelection);

          // Set up dropzone
          setupDropzone();

          log("info", "Components initialized successfully");
          updateStatus("Components initialized", "success");

          // End render timing
          const renderTime = performanceMonitor.endRender();
          log(
            "success",
            `Initial render completed in ${renderTime.toFixed(2)}ms`
          );
        } catch (error) {
          log("error", `Failed to initialize components: ${error.message}`);
          updateStatus("Initialization failed", "error");
        }
      }

      // Setup dropzone with drag and drop
      function setupDropzone() {
        const dropzone = document.getElementById("main-dropzone");

        // Prevent default drag behaviors
        ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
          dropzone.addEventListener(eventName, preventDefaults, false);
          document.body.addEventListener(eventName, preventDefaults, false);
        });

        // Highlight drop area when item is dragged over it
        ["dragenter", "dragover"].forEach((eventName) => {
          dropzone.addEventListener(eventName, highlight, false);
        });

        ["dragleave", "drop"].forEach((eventName) => {
          dropzone.addEventListener(eventName, unhighlight, false);
        });

        // Handle dropped files
        dropzone.addEventListener("drop", handleDrop, false);

        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }

        function highlight(e) {
          dropzone.classList.add("drag-over");
        }

        function unhighlight(e) {
          dropzone.classList.remove("drag-over");
        }

        function handleDrop(e) {
          const dt = e.dataTransfer;
          const files = [...dt.files];
          handleFiles(files);
        }
      }

      // Handle file selection (from input or drop)
      async function handleFiles(files) {
        try {
          log("info", `Processing ${files.length} files...`);

          // Validate files using our InputValidator
          const validation = InputValidator.validateFileList(files);
          if (!validation.isValid) {
            log(
              "error",
              `File validation failed: ${validation.errors.join(", ")}`
            );
            updateStatus("File validation failed", "error");
            return;
          }

          if (validation.warnings.length > 0) {
            validation.warnings.forEach((warning) => log("warn", warning));
          }

          // Process files
          const fileProcessor = new FileProcessor({
            maxFiles: DEFAULT_CONFIG.upload.defaultMaxFiles,
            maxFileSize: DEFAULT_CONFIG.fileSize.defaultMaxSize,
            allowedTypes: ["image/*", "video/*", "application/*", "text/*"],
          });

          const result = await fileProcessor.processFiles(files);

          if (result.success) {
            currentFiles = [...currentFiles, ...result.files];
            log(
              "success",
              `Successfully processed ${result.files.length} files`
            );
            updateStatus(`Processed ${result.files.length} files`, "success");

            // Update UI
            updateFileList();
            generatePreviews();

            // Set up drag reorder for new files
            setupDragReorder();
          } else {
            log("error", `File processing failed: ${result.errors.join(", ")}`);
            updateStatus("File processing failed", "error");
          }
        } catch (error) {
          log("error", `Error handling files: ${error.message}`);
          updateStatus("Error processing files", "error");
        }
      }

      // Handle file selection from input
      function handleFileSelection(e) {
        const files = [...e.target.files];
        handleFiles(files);
      }

      // Update file list display
      function updateFileList() {
        const fileList = document.getElementById("file-list");
        fileList.innerHTML = "";

        currentFiles.forEach((file, index) => {
          const fileItem = document.createElement("div");
          fileItem.className = "file-item";
          fileItem.draggable = true;
          fileItem.dataset.index = index;
          fileItem.dataset.fileId = file.id;

          fileItem.innerHTML = `
                    <div class="file-preview">
                        ${
                          file.preview
                            ? `<img src="${file.preview}" alt="${file.name}" class="file-preview">`
                            : `<div style="background: #e5e7eb; height: 100%; display: flex; align-items: center; justify-content: center; color: #6b7280;">
                            ${getFileIcon(file.type)}
                           </div>`
                        }
                    </div>
                    <div class="file-info">
                        <strong>${file.name}</strong><br>
                        Size: ${formatFileSize(file.size)}<br>
                        Type: ${file.type}<br>
                        Status: <span style="color: ${getStatusColor(file.status)}">${file.status}</span>
                    </div>
                    ${
                      file.status === "uploading"
                        ? `
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${file.progress}%"></div>
                        </div>
                    `
                        : ""
                    }
                    <button class="btn btn-danger" style="position: absolute; top: 5px; right: 5px; padding: 4px 8px; font-size: 10px;" 
                            onclick="removeFile('${file.id}')">√ó</button>
                `;

          fileList.appendChild(fileItem);
        });
      }

      // Generate previews for files
      async function generatePreviews() {
        const previewContainer = document.getElementById("preview-container");
        previewContainer.innerHTML = "<h3>Generating previews...</h3>";

        try {
          const previewManager = FilePreviewManager.getInstance();

          for (const file of currentFiles) {
            if (
              file.file &&
              (file.file.type.startsWith("image/") ||
                file.file.type.startsWith("video/"))
            ) {
              try {
                const preview = await previewManager.generatePreview(
                  file.file,
                  {
                    maxWidth: DEFAULT_CONFIG.dimensions.defaultMaxWidth,
                    maxHeight: DEFAULT_CONFIG.dimensions.defaultMaxHeight,
                    quality: DEFAULT_CONFIG.quality.defaultImageQuality,
                    generateThumbnail: true,
                    thumbnailSize: DEFAULT_CONFIG.dimensions.thumbnailSize,
                  }
                );

                // Update file with preview
                const fileIndex = currentFiles.findIndex(
                  (f) => f.id === file.id
                );
                if (fileIndex !== -1) {
                  currentFiles[fileIndex].preview =
                    preview.thumbnailUrl || preview.url;
                  currentFiles[fileIndex].previewData = preview;
                }

                log("success", `Generated preview for ${file.name}`);
              } catch (error) {
                log(
                  "error",
                  `Failed to generate preview for ${file.name}: ${error.message}`
                );
              }
            }
          }

          updateFileList();
          updatePreviewContainer();
        } catch (error) {
          log("error", `Error generating previews: ${error.message}`);
        }
      }

      // Update preview container
      function updatePreviewContainer() {
        const previewContainer = document.getElementById("preview-container");
        const filesWithPreviews = currentFiles.filter((f) => f.previewData);

        if (filesWithPreviews.length === 0) {
          previewContainer.innerHTML = "<p>No previews available</p>";
          return;
        }

        previewContainer.innerHTML = `
                <h3>Generated Previews (${filesWithPreviews.length})</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;">
                    ${filesWithPreviews
                      .map(
                        (file) => `
                        <div style="text-align: center;">
                            <img src="${file.preview}" alt="${file.name}" style="width: 100%; height: 100px; object-fit: cover; border-radius: 4px;">
                            <p style="font-size: 12px; margin: 5px 0;">${file.name}</p>
                            ${
                              file.previewData.metadata
                                ? `
                                <p style="font-size: 10px; color: #6b7280;">
                                    ${file.previewData.metadata.originalWidth}√ó${file.previewData.metadata.originalHeight}
                                </p>
                            `
                                : ""
                            }
                        </div>
                    `
                      )
                      .join("")}
                </div>
            `;
      }

      // Setup drag and reorder functionality
      function setupDragReorder() {
        const fileList = document.getElementById("file-list");

        // Register container
        dragReorderManager.setContainer(fileList);

        // Register each file item
        currentFiles.forEach((file, index) => {
          const fileElement = fileList.querySelector(
            `[data-file-id="${file.id}"]`
          );
          if (fileElement) {
            dragReorderManager.registerItem(file.id, fileElement);
          }
        });

        // Set files in drag manager
        dragReorderManager.setFiles(currentFiles);

        // Listen for reorder events
        fileList.addEventListener("fileReorder", (event) => {
          const { fromIndex, toIndex, newOrder } = event.detail;
          log("info", `File reordered from index ${fromIndex} to ${toIndex}`);

          // Update our file array
          currentFiles = newOrder;
          updateFileList();

          // Re-register elements
          setupDragReorder();
        });
      }

      // Remove a file
      function removeFile(fileId) {
        currentFiles = currentFiles.filter((f) => f.id !== fileId);
        updateFileList();
        updatePreviewContainer();
        log("info", `File removed: ${fileId}`);
      }

      // Test functions
      window.testFileUpload = function () {
        log("info", "üß™ Testing file upload functionality...");
        testResults.fileUpload = "Testing...";
        updateTestResults();

        // Simulate file upload
        setTimeout(() => {
          testResults.fileUpload = "‚úÖ Passed";
          log("success", "File upload test completed successfully");
          updateTestResults();
        }, 1000);
      };

      window.testDragReorder = function () {
        log("info", "üß™ Testing drag and reorder functionality...");
        testResults.dragReorder = "Testing...";
        updateTestResults();

        if (currentFiles.length < 2) {
          testResults.dragReorder = "‚ö†Ô∏è Need at least 2 files to test";
          log("warn", "Need at least 2 files to test drag and reorder");
        } else {
          testResults.dragReorder = "‚úÖ Ready to test (drag files to reorder)";
          log("success", "Drag and reorder test ready");
        }
        updateTestResults();
      };

      window.testFilePreview = function () {
        log("info", "üß™ Testing file preview functionality...");
        testResults.filePreview = "Testing...";
        updateTestResults();

        if (currentFiles.some((f) => f.previewData)) {
          testResults.filePreview = "‚úÖ Passed";
          log("success", "File preview test completed successfully");
        } else {
          testResults.filePreview = "‚ö†Ô∏è No previews available";
          log("warn", "No file previews available for testing");
        }
        updateTestResults();
      };

      window.testErrorHandling = function () {
        log("info", "üß™ Testing error handling...");
        testResults.errorHandling = "Testing...";
        updateTestResults();

        try {
          // Test validation error
          const validation = InputValidator.validateFileList("invalid");
          if (!validation.isValid) {
            testResults.errorHandling = "‚úÖ Passed";
            log("success", "Error handling test completed successfully");
          }
        } catch (error) {
          testResults.errorHandling = "‚ùå Failed";
          log("error", `Error handling test failed: ${error.message}`);
        }
        updateTestResults();
      };

      window.testPerformance = function () {
        log("info", "üß™ Testing performance monitoring...");
        testResults.performance = "Testing...";
        updateTestResults();

        try {
          const metrics = performanceMonitor.getMetrics();
          if (metrics) {
            testResults.performance = "‚úÖ Passed";
            log(
              "success",
              `Performance test completed. Render time: ${metrics.runtime.renderTime.toFixed(2)}ms`
            );
          }
        } catch (error) {
          testResults.performance = "‚ùå Failed";
          log("error", `Performance test failed: ${error.message}`);
        }
        updateTestResults();
      };

      window.clearAll = function () {
        currentFiles = [];
        updateFileList();
        updatePreviewContainer();
        log("info", "All files cleared");
        updateStatus("All files cleared", "info");
      };

      // Utility functions
      function getFileIcon(type) {
        if (type.startsWith("image/")) return "üñºÔ∏è";
        if (type.startsWith("video/")) return "üé•";
        if (type.startsWith("audio/")) return "üéµ";
        if (type.includes("pdf")) return "üìÑ";
        if (type.includes("text")) return "üìù";
        if (type.includes("zip") || type.includes("rar")) return "üì¶";
        return "üìÅ";
      }

      function getStatusColor(status) {
        switch (status) {
          case "pending":
            return "#6b7280";
          case "uploading":
            return "#3b82f6";
          case "success":
            return "#10b981";
          case "error":
            return "#ef4444";
          case "cancelled":
            return "#f59e0b";
          default:
            return "#6b7280";
        }
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + " " + sizes[i];
      }

      function log(level, message) {
        const logContainer = document.getElementById("log-container");
        const entry = document.createElement("div");
        entry.className = `log-entry ${level}`;
        entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${level.toUpperCase()}: ${message}`;
        logContainer.appendChild(entry);
        logContainer.scrollTop = logContainer.scrollHeight;
      }

      function updateStatus(message, type) {
        const statusDiv = document.getElementById("test-status");
        statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
      }

      function updateTestResults() {
        const resultsDiv = document.getElementById("test-results");
        resultsDiv.innerHTML = `
                <h3>Test Results:</h3>
                <ul>
                    ${Object.entries(testResults)
                      .map(
                        ([test, result]) =>
                          `<li><strong>${test}:</strong> ${result}</li>`
                      )
                      .join("")}
                </ul>
            `;
      }

      function updatePerformanceStats() {
        const statsDiv = document.getElementById("performance-stats");
        try {
          const metrics = performanceMonitor.getMetrics();
          statsDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: #f3f4f6; padding: 15px; border-radius: 6px;">
                            <h4>Render Performance</h4>
                            <p>Render Time: ${metrics.runtime.renderTime.toFixed(2)}ms</p>
                            <p>Memory Usage: ${(metrics.runtime.memoryUsage / 1024 / 1024).toFixed(2)}MB</p>
                        </div>
                        <div style="background: #f3f4f6; padding: 15px; border-radius: 6px;">
                            <h4>Upload Performance</h4>
                            <p>Upload Speed: ${metrics.runtime.uploadSpeed.toFixed(2)} files/s</p>
                            <p>Success Rate: ${(metrics.userExperience.successRate * 100).toFixed(1)}%</p>
                        </div>
                        <div style="background: #f3f4f6; padding: 15px; border-radius: 6px;">
                            <h4>Bundle Info</h4>
                            <p>Raw Size: ${(metrics.bundleSize.raw / 1024).toFixed(1)}KB</p>
                            <p>Gzipped: ${(metrics.bundleSize.gzipped / 1024).toFixed(1)}KB</p>
                        </div>
                    </div>
                `;
        } catch (error) {
          statsDiv.innerHTML = "<p>Performance metrics not available</p>";
        }
      }

      // Initialize everything when page loads
      document.addEventListener("DOMContentLoaded", () => {
        initializeComponents();

        // Update performance stats every 2 seconds
        setInterval(updatePerformanceStats, 2000);

        log("success", "Test page loaded successfully");
        updateStatus("Ready for testing", "success");
      });
    </script>
  </body>
</html>
